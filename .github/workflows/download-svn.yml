name: Download SVN Binaries

on:
  workflow_call:
    outputs:
      cache-key:
        description: 'Cache key for downloaded binaries'
        value: ${{ jobs.download.outputs.cache-key }}
  workflow_dispatch:

env:
  SVN_VERSION: '1.14.5'
  CACHE_KEY_PREFIX: 'svn-binaries-v1'

jobs:
  download:
    runs-on: ${{ matrix.runner }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win32
            arch: x64
            runner: windows-latest
            artifact-name: svn-win32-x64
          - platform: darwin
            arch: x64
            runner: macos-15-intel
            artifact-name: svn-darwin-x64
          - platform: darwin
            arch: arm64
            runner: macos-14
            artifact-name: svn-darwin-arm64
    
    outputs:
      cache-key: ${{ env.CACHE_KEY_PREFIX }}-${{ env.SVN_VERSION }}
    
    steps:
      - name: Download SVN for Windows
        if: matrix.platform == 'win32'
        shell: pwsh
        run: |
          # Create binaries directory
          New-Item -ItemType Directory -Force -Path binaries\win32-x64\svn
          
          # Download VisualSVN command-line tools
          # URL format changed in late 2025 - now a unified package
          $svnUrl = "https://www.visualsvn.com/files/Apache-Subversion-${{ env.SVN_VERSION }}-3.zip"
          
          Write-Host "Downloading SVN from $svnUrl"
          Invoke-WebRequest -Uri $svnUrl -OutFile svn.zip
          
          # Extract
          Expand-Archive -Path svn.zip -DestinationPath svn-temp
          
          # Move binaries to expected location (new package structure)
          Move-Item -Path "svn-temp\bin\*" -Destination "binaries\win32-x64\svn\" -Force
          
          # Verify
          binaries\win32-x64\svn\svn.exe --version
          
          # Cleanup
          Remove-Item svn.zip, svn-temp -Recurse -Force
      
      - name: Download SVN for macOS
        if: matrix.platform == 'darwin'
        run: |
          # Create binaries directory
          mkdir -p binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/lib
          
          # Install SVN and dylibbundler via Homebrew
          brew install subversion dylibbundler
          
          # Find the svn binary location
          SVN_PATH=$(which svn)
          
          echo "SVN installed at: $SVN_PATH"
          svn --version
          
          # Copy the svn binary
          cp "$SVN_PATH" binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/
          
          # Bundle all dependencies using dylibbundler
          # This copies all dylibs to lib/ folder and fixes install names
          dylibbundler -od -b \
            -x binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/svn \
            -d binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/lib \
            -p @executable_path/lib
          
          # Make executable
          chmod +x binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/svn
          
          # Verify the bundled binary works
          binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/svn --version
          
          # List what we have
          echo "Bundled contents:"
          ls -la binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/
          echo "Bundled libraries:"
          ls -la binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/lib/
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: binaries/${{ matrix.platform }}-${{ matrix.arch }}
          retention-days: 7
          if-no-files-found: error

  # Create universal macOS binary (combines x64 + arm64)
  create-universal:
    needs: download
    runs-on: macos-14
    
    steps:
      - name: Download x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: svn-darwin-x64
          path: binaries/darwin-x64
      
      - name: Download arm64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: svn-darwin-arm64
          path: binaries/darwin-arm64
      
      - name: Create universal binary
        run: |
          mkdir -p binaries/darwin-universal/svn/lib
          
          # Create universal svn binary using lipo
          lipo -create \
            binaries/darwin-x64/svn/svn \
            binaries/darwin-arm64/svn/svn \
            -output binaries/darwin-universal/svn/svn
          
          chmod +x binaries/darwin-universal/svn/svn
          
          # Create universal dylibs by merging x64 and arm64 versions
          # Get list of dylibs from x64 (they should be the same in arm64)
          for dylib in binaries/darwin-x64/svn/lib/*.dylib; do
            libname=$(basename "$dylib")
            arm64_lib="binaries/darwin-arm64/svn/lib/$libname"
            
            if [ -f "$arm64_lib" ]; then
              echo "Creating universal dylib: $libname"
              lipo -create "$dylib" "$arm64_lib" -output "binaries/darwin-universal/svn/lib/$libname"
            else
              echo "Warning: $libname not found in arm64, copying x64 version"
              cp "$dylib" binaries/darwin-universal/svn/lib/
            fi
          done
          
          # Verify universal binary
          echo "Universal svn binary:"
          lipo -info binaries/darwin-universal/svn/svn
          
          echo "Universal dylibs:"
          ls -la binaries/darwin-universal/svn/lib/
          
          # Test the universal binary
          binaries/darwin-universal/svn/svn --version
      
      - name: Upload universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: svn-darwin-universal
          path: binaries/darwin-universal
          retention-days: 7

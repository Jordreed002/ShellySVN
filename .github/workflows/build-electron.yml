name: Build Electron App

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SVN_VERSION: '1.14.5'

jobs:
  # ============================================
  # Build SVN Binaries (with caching)
  # ============================================
  svn-binaries:
    runs-on: ${{ matrix.runner }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win32
            arch: x64
            runner: windows-latest
            artifact-name: svn-win32-x64
          - platform: darwin
            arch: x64
            runner: macos-15-intel
            artifact-name: svn-darwin-x64
          - platform: darwin
            arch: arm64
            runner: macos-14
            artifact-name: svn-darwin-arm64
    
    steps:
      - name: Cache SVN binaries
        id: cache-svn
        uses: actions/cache@v4
        with:
          path: binaries/${{ matrix.platform }}-${{ matrix.arch }}
          key: svn-${{ matrix.platform }}-${{ matrix.arch }}-${{ env.SVN_VERSION }}
      
      - name: Download SVN for Windows
        if: matrix.platform == 'win32' && steps.cache-svn.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path binaries\win32-x64\svn
          $svnUrl = "https://www.visualsvn.com/files/Apache-Subversion-${{ env.SVN_VERSION }}-3.zip"
          Write-Host "Downloading SVN from $svnUrl"
          Invoke-WebRequest -Uri $svnUrl -OutFile svn.zip
          Expand-Archive -Path svn.zip -DestinationPath svn-temp
          Move-Item -Path "svn-temp\bin\*" -Destination "binaries\win32-x64\svn\" -Force
          binaries\win32-x64\svn\svn.exe --version
          Remove-Item svn.zip, svn-temp -Recurse -Force
      
      - name: Download SVN for macOS
        if: matrix.platform == 'darwin' && steps.cache-svn.outputs.cache-hit != 'true'
        run: |
          mkdir -p binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/lib
          brew install subversion dylibbundler
          SVN_PATH=$(which svn)
          echo "SVN installed at: $SVN_PATH"
          svn --version
          cp "$SVN_PATH" binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/
          dylibbundler -od -b \
            -x binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/svn \
            -d binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/lib \
            -p @executable_path/lib
          chmod +x binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/svn
          binaries/${{ matrix.platform }}-${{ matrix.arch }}/svn/svn --version
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: binaries/${{ matrix.platform }}-${{ matrix.arch }}
          retention-days: 1

  # ============================================
  # Build Logic Engine (with caching)
  # ============================================
  logic-engine:
    runs-on: ${{ matrix.runner }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win32
            arch: x64
            runner: windows-latest
            target: bun-windows-x64
            ext: .exe
            artifact-name: shelly-engine-win32-x64
          - platform: darwin
            arch: x64
            runner: macos-15-intel
            target: bun-darwin-x64
            ext: ''
            artifact-name: shelly-engine-darwin-x64
          - platform: darwin
            arch: arm64
            runner: macos-14
            target: bun-darwin-arm64
            ext: ''
            artifact-name: shelly-engine-darwin-arm64
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate cache key from source
        id: cache-key
        run: |
          echo "key=logic-engine-${{ matrix.platform }}-${{ matrix.arch }}-${{ hashFiles('packages/logic-engine/**/*.ts', 'packages/logic-engine/package.json', 'bun.lock') }}" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Cache Logic Engine binary
        id: cache-engine
        uses: actions/cache@v4
        with:
          path: binaries/${{ matrix.platform }}-${{ matrix.arch }}
          key: ${{ steps.cache-key.outputs.key }}
      
      - name: Setup Bun
        if: steps.cache-engine.outputs.cache-hit != 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.0'
      
      - name: Install dependencies
        if: steps.cache-engine.outputs.cache-hit != 'true'
        working-directory: packages/logic-engine
        run: bun install --frozen-lockfile
      
      - name: Build binary
        if: steps.cache-engine.outputs.cache-hit != 'true'
        working-directory: packages/logic-engine
        run: bun build ./src/index.ts --compile --target=${{ matrix.target }} --outfile=dist/shelly-engine${{ matrix.ext }} --minify --define ENGINE_VERSION='"${{ github.ref_name }}"' --define BUILD_SHA='"${{ github.sha }}"'
      
      - name: Verify binary
        if: steps.cache-engine.outputs.cache-hit != 'true'
        working-directory: packages/logic-engine
        run: ./dist/shelly-engine${{ matrix.ext }} --version
      
      - name: Move to binaries directory
        if: steps.cache-engine.outputs.cache-hit != 'true'
        run: |
          mkdir -p binaries/${{ matrix.platform }}-${{ matrix.arch }}
          mv packages/logic-engine/dist/shelly-engine${{ matrix.ext }} binaries/${{ matrix.platform }}-${{ matrix.arch }}/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: binaries/${{ matrix.platform }}-${{ matrix.arch }}/shelly-engine${{ matrix.ext }}
          retention-days: 1

  # ============================================
  # Build Electron App - macOS
  # ============================================
  build-macos:
    needs: [svn-binaries, logic-engine]
    runs-on: ${{ matrix.runner }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.0'
      
      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-deps-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-deps-${{ runner.os }}-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Download SVN binaries
        uses: actions/download-artifact@v4
        with:
          name: svn-darwin-${{ matrix.arch }}
          path: binaries/darwin-${{ matrix.arch }}
      
      - name: Download Logic Engine
        uses: actions/download-artifact@v4
        with:
          name: shelly-engine-darwin-${{ matrix.arch }}
          path: binaries/darwin-${{ matrix.arch }}
      
      - name: Make binaries executable
        run: |
          chmod +x binaries/darwin-${{ matrix.arch }}/shelly-engine
          chmod +x binaries/darwin-${{ matrix.arch }}/svn/svn
      
      - name: Cache Electron build output
        uses: actions/cache@v4
        with:
          path: |
            out
            .cache
          key: electron-out-${{ matrix.arch }}-${{ hashFiles('src/**/*', 'package.json', 'bun.lock') }}
          restore-keys: |
            electron-out-${{ matrix.arch }}-
      
      - name: Build frontend
        run: bun run build
      
      - name: Build Electron app
        run: bunx electron-builder --mac --${{ matrix.arch }} --config
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShellySVN-macOS-${{ matrix.arch }}
          path: |
            release/**/*.dmg
            release/**/*.zip
          retention-days: 7
  
  # ============================================
  # Build Electron App - Windows
  # ============================================
  build-windows:
    needs: [svn-binaries, logic-engine]
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.0'
      
      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-deps-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-deps-${{ runner.os }}-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Download SVN binaries
        uses: actions/download-artifact@v4
        with:
          name: svn-win32-x64
          path: binaries/win32-x64
      
      - name: Download Logic Engine
        uses: actions/download-artifact@v4
        with:
          name: shelly-engine-win32-x64
          path: binaries/win32-x64
      
      - name: Cache Electron build output
        uses: actions/cache@v4
        with:
          path: |
            out
            .cache
          key: electron-out-win32-x64-${{ hashFiles('src/**/*', 'package.json', 'bun.lock') }}
          restore-keys: |
            electron-out-win32-x64-
      
      - name: Build frontend
        run: bun run build
      
      - name: Build Electron app
        run: bunx electron-builder --win --x64 --config
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShellySVN-Windows-x64
          path: |
            release/**/*.exe
            release/**/*.zip
          retention-days: 7

  # ============================================
  # Release (only on tags or manual dispatch)
  # ============================================
  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || inputs.create_release == 'true'
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ShellySVN v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ShellySVN v${{ steps.get_version.outputs.VERSION }}
            
            ### Downloads
            - **Windows**: `ShellySVN-Setup-x.x.x.exe`
            - **macOS (Intel)**: `ShellySVN-x.x.x-x64.dmg`
            - **macOS (Apple Silicon)**: `ShellySVN-x.x.x-arm64.dmg`
            
            ### What's Changed
            See commit history for details.
          files: |
            artifacts/**/*
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
